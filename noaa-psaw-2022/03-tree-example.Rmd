---
title: "Example: Spatial modeling of trees in a rainforest"
subtitle: "NOAA PSAW Seminar Series"
author: "Names Here"
institute: ""
date: "2022-03-02"
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "theme.css"]
    lib_dir: libs
    nature:
      highlightLines: true
      countIncrementalSlides: false
---

<!-- Previous slides: https://www.dropbox.com/s/gu43n4gvqmo0uzy/sdmTMB-intro-2021.pdf?dl=1 -->

<!-- Build with: xaringan::inf_mr() -->

```{r options, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  dpi = 300,
  out.width = "700px",
  fig.asp = 1/1.618,
  cache = TRUE,
  autodep = TRUE,
  cache.comments = TRUE,
  fig.align = "center",
  echo = FALSE
)
```

```{r style, include=FALSE, cache=FALSE}
source(here::here("noaa-psaw-2022/preamble.R"))
```

```{r libs, include=FALSE}
library(dplyr)
library(sdmTMB)
library(ggplot2)
theme_set(theme_light())
```

---

class: center, middle, inverse

# A first spatial model

---

# The bei dataset

.medium[
```{r, echo=TRUE}
library(dplyr)
library(ggplot2)
library(spatstat)
data(bei)

as.data.frame(bei) %>% 
  select(x, y) %>% 
  head()
```
]

---

# Spatial patterning of trees

* Barro Colorado Island = classic in ecology
  * Hubbell's (2001) unified neutral theory of biodiversity
  
```{r plot-trees, fig.asp=0.5}
ggplot(as.data.frame(bei), aes(x,y)) +
  geom_point(col="darkblue",alpha=0.1) + 
  theme_bw()
```

---

# Lattice representation

* Used in INLA book, other R packages (`spatstat`)  

```{r plot-trees-grid, fig.asp=0.5}
# scale controls resolution
scale = 50
data(bei)
bei_grid = as.data.frame(bei)
bei_grid$x = scale*floor(bei_grid$x/scale)
bei_grid$y = scale*floor(bei_grid$y/scale)

bei_grid = dplyr::group_by(bei_grid, x, y) %>% 
  dplyr::summarise(n = n()) 

ggplot(bei_grid, aes(x, y, fill = n)) + 
  geom_tile() + theme_bw()
```

---

# What type of distribution?

* Counts
* Skewed
* Zero-truncated (locations of measured trees)

```{r tree-hist, fig.asp=0.5}
ggplot(bei_grid, aes(n)) + 
  geom_histogram(bins=100,col="darkblue") + 
  theme_bw() + xlab("# Trees")
```

---

# What type of distribution?

* For simplicity, we could ignore truncation and use `nbinom2()`

* `sdmTMB` has several additional families for censored data
  * `truncated_nbinom1()`
  * `truncated_nbinom2()` 
  * `censored_poisson()`
  
---

# Creating a mesh

.small[
```{r make-mesh, echo=TRUE}
mesh = make_mesh(bei_grid, xy_cols = c("x","y"), cutoff=80)

# extract number of vertices/knots
mesh$mesh$n
```
]

```{r fig.asp=0.5}
ggplot() + inlabru::gg(mesh$mesh) +
  geom_point(data = bei_grid, aes(x = x, y = y, col = n)) +
  coord_equal()
```

---

# A first model

```{r fit-model, echo=TRUE}
fit <- sdmTMB(
  n ~ 1,
  data = bei_grid,
  mesh = mesh,
  family = truncated_nbinom2(),
)
```

---

# Inspecting the model output

.small[
```{r inspect1, echo=TRUE, highlight.output=c(1)}
summary(fit)
```
]

---

# Inspecting the model output

.small[
```{r inspect2, echo=TRUE, highlight.output=2:5}
summary(fit)
```
]

---

# Inspecting the model output

.small[
```{r inspect3, echo=TRUE, highlight.output=6:7}
summary(fit)
```
]

---

# Inspecting the model output

.small[
```{r inspect4, echo=TRUE, highlight.output=9:11}
summary(fit)
```
]

---

# Extracting parameters in a data frame

```{r extract, echo=TRUE}
# Main effects:
tidy(fit)

# Variance-related terms:
tidy(fit, effects = "ran_pars")
```

---

# Extracting parameters in a data frame

.small[
```{r, echo=TRUE}
tidy(fit, "ran_pars", conf.int = TRUE) %>% 
  as_tibble()
```
]

---

# Plotting spatial random effects

.small[
```{r, echo=TRUE}
ggplot(p, aes(x, y, fill = omega_s)) +
  geom_raster() +
  scale_fill_gradient2() +
  coord_fixed()
```
]

---

# Making predictions

.small[
```{r, echo=TRUE}
p <- predict(fit)
select(p, x, y, est:omega_s) %>% 
  glimpse()
```
]

---

# Making predictions

* `est`: Overall estimate **in link space**
* `est_non_rf`: Estimate of non-random-field components
* `est_rf`: Estimate of random-field components
* `omega_s`: Spatial random field

---

# Making predictions on new data

* Let's project to the whole BCI region (on a grid)
* Create a new df for predictions

```{r echo = TRUE}
newdf = expand.grid(x = unique(bei_grid$x),
                      y = unique(bei_grid$y))
```

---

# Making predictions on new data

* `sdmTMB` has predict() function just like other packages 

```{r, echo=TRUE}
p <- predict(fit, newdata = newdf)
```

---

# Plotting predictions on new data

.small[
```{r, echo=TRUE}
ggplot(p, aes(x, y, fill = est)) +
  geom_raster() +
  scale_fill_viridis_c() +
  coord_fixed()
```
]

---

# Predictions in normal space

.small[
```{r, echo=TRUE}
ggplot(p, aes(x, y, fill = exp(est))) +
  geom_raster() +
  scale_fill_viridis_c() +
  coord_fixed()
```
]

