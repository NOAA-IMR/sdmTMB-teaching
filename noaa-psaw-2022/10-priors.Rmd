---
title: "Priors and parameter bounds"
subtitle: "NOAA PSAW Seminar Series"
author: ""
institute: ""
date: "March 9, 2022"
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "theme.css"]
    lib_dir: libs
    nature:
      highlightLines: true
      countIncrementalSlides: false
---

<!-- Build with: xaringan::inf_mr() -->

```{r preamble, include=FALSE, cache=FALSE}
source(here::here("noaa-psaw-2022/preamble.R"))
do.call(knitr::opts_chunk$set, knitr_opts)
```

```{r libs, include=FALSE}
library(dplyr)
library(sdmTMB)
library(ggplot2)
```

# Maximum likelihood doesn't involve priors!? 

* Penalized maximum likelihood estimation

* Maximize 

$$L(\theta | y) * P(\theta | \alpha)$$
* $\theta$ are parameters
* $\alpha$ are hyperparameters controlling prior distribution  

---

# Penalized estimation in sdmTMB


```{r echo = TRUE, eval=FALSE}
fit <- sdmTMB(...,
              priors, #<<
              ...)
```

* `?sdmTMBpriors` 

---

# What can we put priors on?

$\beta$ fixed effects  
$\phi$ Observation variance parameter  
$\rho$ AR(1) parameter for spatiotemporal fields  
$p$ Tweedie parameter (variance power)  
$\kappa$ Matérn range   
$\sigma$ Matérn variance  

---

# Example: regression coefficients

* Simple prior on $b_{1}$

* Note: don't have to specify a prior on all coefficients  
.small[
```{r echo=TRUE}
mesh <- make_mesh(pcod, 
  xy_cols = c("X", "Y"), 
  cutoff = 10)
fit_prior <- sdmTMB(present ~ depth,
  data = pcod, mesh = mesh,
  family = binomial(link = "logit"),
  spatiotemporal = "off",
  priors = sdmTMBpriors(b = normal(c(4.2,NA), 
          c(0.1,NA))) #<<
)
```
]
  
  
---

# Example: regression coefficients

```{r echo=TRUE}
tidy(fit_prior)
```
  
Compare to model without priors  
```{r echo = FALSE}
fit <- sdmTMB(
  present ~ depth,
  data = pcod,
  mesh = mesh,
  family = binomial(link = "logit"),
  spatiotemporal = "off"
)
```

```{r echo=TRUE}
tidy(fit)
```

---

# Example: regression coefficients

* Covariance in fixed effects can be included with `mvnormal`
.small[
```{r echo=TRUE, eval=FALSE}
fit_prior <- sdmTMB(
  present ~ depth,
  data = pcod,
  mesh = mesh,
  family = binomial(link = "logit"),
  spatiotemporal = "off",
  priors = sdmTMBpriors(b = mvnormal(b_loc, scale = b_Sigma)) #<<
)
```
]

---

# Example: Matern

* PC prior example

---

# Bounds

* Sometimes we may want to put hard bounds on a parameter

`?sdmTMBcontrol`

* Example: constrain depth effect on occurrence to be negative  
.small[
```{r eval=FALSE, echo=TRUE}
fit <- sdmTMB(
  present ~ depth,
  data = pcod,
  mesh = mesh,
  family = binomial(link = "logit"),
  spatiotemporal = "off",
  control = sdmTMBcontrol(lower = list(b_j = c(NA,NA),
                          upper = list(b_j = c(NA,0))))
)
```
]
