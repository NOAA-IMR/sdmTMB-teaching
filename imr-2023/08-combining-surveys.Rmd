---
title: "Combining data from multiple surveys"
subtitle: "IMR sdmTMB workshop"
author: ""
institute: ""
date: "May 23--25 2023"
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "theme.css"]
    lib_dir: libs
    nature:
      highlightLines: true
      countIncrementalSlides: false
---

<!-- Build with: xaringan::inf_mr() -->

```{r preamble, include=FALSE, cache=FALSE}
source("preamble.R")
do.call(knitr::opts_chunk$set, knitr_opts)
```

```{r libs, include=FALSE}
library(dplyr)
library(sdmTMB)
library(ggplot2)
library(viridis)
```

# Combining surveys is a common challenge

* Ideally overlapping in time - space

* Otherwise some set of parameters need to be shared

---

# Combining surveys is a common challenge

```{r}
df = data.frame(Year = 1980:2020)
set.seed(123)
df$y <- cumsum(rnorm(nrow(df))) + 3
df$y[15:25] = NA
df$Survey <- c(rep("Survey 1",25), rep("Survey 2",16))
ggplot(df, aes(Year,y, col=Survey)) + 
  geom_line(linewidth=1) + 
  geom_point(size=3) + 
  theme_bw() + ylab("CPUE") + 
  scale_color_viridis_d(end=0.8)
```

---

# Combining surveys is a common challenge

* Gaps in time may be smoothed if:
* Assumption: equal catchability between surveys (scales intercept)
* Reasonable to use smooth or time-varying coefficients  

```{r eval=FALSE, echo=TRUE}
fit <- sdmTMB(density ~ s(year), ...)

fit <- sdmTMB(density ~ 1, 
              time_varying = ~ 1,
              time="year",...)

fit <- sdmTMB(density ~ 1, 
              time="year",
              spatiotemporal "ar1",
              ...)
```

---

# Combining surveys is a common challenge

* Ok if assumption of equal catchabilty is equal. 
```{r warning=FALSE, message=FALSE}
set.seed(123)
df1 <- data.frame(X = runif(500, min=0,max=500),
             Y = runif(500, min=0,max=500))
df2 <- data.frame(X = runif(500, min=500,max=1000),
             Y = runif(500, min=500,max=1000))
df1$Survey = "Survey 1"
df2$Survey = "Survey 2"

df <- rbind(df1, df2)
ggplot(df, aes(X,Y, col=Survey)) + 
  geom_point() + 
  theme_bw() + 
  scale_color_viridis_d(end=0.8)
```

---

# Overlapping surveys and catchability

```{r warning=FALSE, message=FALSE}
set.seed(123)
df1 <- data.frame(X = runif(500, min=0,max=800),
             Y = runif(500, min=0,max=800))
df2 <- data.frame(X = runif(500, min=200,max=1000),
             Y = runif(500, min=200,max=1000))
df1$Survey = "Survey 1"
df2$Survey = "Survey 2"

df <- rbind(df1, df2)
ggplot(df, aes(X,Y, col=Survey)) + 
  geom_point() + 
  theme_bw() + 
  scale_color_viridis_d(end=0.8)
```

---

# Overlapping surveys and catchability

```{r}
fit <- sdmTMB(density ~ fyear + survey, ...)

fit <- sdmTMB(density ~ fyear * survey, ...)

fit <- sdmTMB(density ~ s(year, by = survey), ...)
```

---

# Overlapping surveys and catchability

*Example: * combining trawl and acoustic surveys for pelagic species



---

# What sdmTMB cannot (yet) do

* Combine surveys using multiple responses (counts, densities)

--- 





